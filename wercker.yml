box: golang:1.8

deploy:
  steps:
    - script:
        name: Register Inventory REST service in APIP
        code: |
          which kubectl
          INVENTORY_CONTEXTPATH=$(egrep -o '"([^"]*)"' $WERCKER_SOURCE_DIR/src/main/java/io/CustomContainer.java | sed -r 's/"(.*)"/\1/')
          echo 'Context path=' $INVENTORY_CONTEXTPATH
          CONTAINER_HOST=$(kubectl get service rest-inventory -o jsonpath={.status.loadBalancer.ingress[0].ip})
          echo 'Container host=' $CONTAINER_HOST
    - kubectl:
        server: $KUBERNETES_MASTER
        token: $KUBERNETES_TOKEN
        insecure-skip-tls-verify: true
        command: get service rest-inventory -o jsonpath={.status.loadBalancer.ingress[0].ip}
    - kubectl:
        server: $KUBERNETES_MASTER
        token: $KUBERNETES_TOKEN
        insecure-skip-tls-verify: true
        command: create -f $WERCKER_ROOT/inventory-cassandra-OKE.yaml
